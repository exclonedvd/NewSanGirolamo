/*! app.v2.min.js â€” UI + Weather + Slider (safe-min) */

(()=>{
  const UI = {
    deferred: null,
    toggleNav(){ const ul = document.querySelector('.nav ul'); if (ul) ul.classList.toggle('open'); },
    promptInstall(){
      if ('standalone' in navigator && navigator.standalone) {
        alert(document.documentElement.lang==='en' ? 'On iPhone: Share â†’ Add to Home Screen' :
              document.documentElement.lang==='de' ? 'Auf iPhone: Teilen â†’ Zum Home-Bildschirm' :
              'Su iPhone: Condividi â†’ Aggiungi alla schermata Home'); return;
      }
      if (UI.deferred) { UI.deferred.prompt(); UI.deferred = null; }
      else { alert(document.documentElement.lang==='en' ? 'On iPhone: Share â†’ Add to Home Screen' :
                   document.documentElement.lang==='de' ? 'Auf iPhone: Teilen â†’ Zum Home-Bildschirm' :
                   'Per iPhone: Condividi â†’ Aggiungi alla schermata Home'); }
    },
    availability(form){
      const d = Object.fromEntries(new FormData(form).entries());
      const lang = (document.documentElement.lang||'it').toLowerCase();
      const subject = lang==='en' ? 'Availability request' : (lang==='de' ? 'VerfÃ¼gbarkeitsanfrage' : 'Richiesta disponibilitÃ ');
      const lines = lang==='en' ? ['Availability request','',`Name: ${d.name||''}`,`Email: ${d.email||''}`,`Phone: ${d.phone||''}`,`Check-in: ${d.checkin||''}`,`Check-out: ${d.checkout||''}`,'Notes:',(d.note||'')]
                  : (lang==='de' ? ['VerfÃ¼gbarkeitsanfrage','',`Name: ${d.name||''}`,`E-Mail: ${d.email||''}`,`Telefon: ${d.phone||''}`,`Check-in: ${d.checkin||''}`,`Check-out: ${d.checkout||''}`,'Notizen:',(d.note||'')]
                  : ['Richiesta disponibilitÃ ','',`Nome: ${d.name||''}`,`Email: ${d.email||''}`,`Telefono: ${d.phone||''}`,`Check-in: ${d.checkin||''}`,`Check-out: ${d.checkout||''}`,'Note:',(d.note||'')]);
      location.href = `mailto:info@agriturismo-sangirolamo.it?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(lines.join('%0A'))}`;
      return false;
    }
  };
  window.UI = UI;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); UI.deferred = e; document.querySelectorAll('#installBtn').forEach(btn=> btn.style.display='inline-flex'); });
  function refreshInstallBtn(){ document.querySelectorAll('#installBtn').forEach(btn=>{ btn.style.display = (UI.deferred || /iPad|iPhone|iPod/.test(navigator.userAgent)) ? 'inline-flex' : ''; }); }
  window.addEventListener('pageshow', refreshInstallBtn);
  document.addEventListener('visibilitychange', ()=> setTimeout(refreshInstallBtn, 100));
  document.addEventListener('DOMContentLoaded', refreshInstallBtn);
})();

(()=>{
  const el = document.getElementById('weather');
  if(!el) return;
  el.classList.add('weather');
  if(!el.dataset.ready){ el.dataset.ready="1"; el.innerHTML = '<div style="text-align:center;opacity:.7">Caricamento meteoâ€¦</div>'; }
  const lat = 45.16, lon = 10.79;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FRome&forecast_days=7`;
  const ICON = {0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'ğŸŒ«ï¸',51:'ğŸŒ¦ï¸',53:'ğŸŒ¦ï¸',55:'ğŸŒ¦ï¸',56:'ğŸŒ§ï¸',57:'ğŸŒ§ï¸',61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',66:'ğŸŒ§ï¸',67:'ğŸŒ§ï¸',71:'ğŸŒ¨ï¸',73:'ğŸŒ¨ï¸',75:'â„ï¸',80:'ğŸŒ§ï¸',81:'ğŸŒ¦ï¸',82:'ğŸŒ§ï¸',95:'â›ˆï¸',96:'â›ˆï¸',99:'â›ˆï¸'};
  const lang = (document.documentElement.lang||'it').toLowerCase();
  const locale = lang==='en' ? 'en-GB' : (lang==='de' ? 'de-DE' : 'it-IT');
  function dayLabel(ts){ return new Date(ts).toLocaleDateString(locale, { weekday:'short' }); }
  function render(d){
    el.innerHTML='';
    d.daily.time.forEach((t,i)=>{
      const max=Math.round(d.daily.temperature_2m_max[i]), min=Math.round(d.daily.temperature_2m_min[i]), icon=ICON[d.daily.weathercode[i]]||'ğŸŒ¦ï¸', label=dayLabel(t);
      const card=document.createElement('div'); card.className='day'; card.innerHTML=`<div class="ico" aria-hidden="true">${icon}</div><div>${label}</div><div>${max}Â° / ${min}Â°</div>`; el.appendChild(card);
    });
  }
  fetch(url).then(r=>r.json()).then(render).catch(err=>{ console.error('[weather] fetch failed', err); el.innerHTML='<div style="text-align:center;opacity:.7">Meteo non disponibile</div>'; });
})();

(()=>{
  function init(){
    fetch('photos.json').then(r=>{ if(!r.ok) throw new Error('photos.json not found'); return r.json(); }).then(PHOTOS=>{
      document.querySelectorAll('.snap-slider').forEach(sl=>{
        const key=sl.getAttribute('data-src')||'Galleria', list=Array.isArray(PHOTOS[key])?PHOTOS[key]:[];
        const rail=document.createElement('div'); rail.className='rail'; rail.setAttribute('role','region'); rail.setAttribute('aria-label', key);
        list.forEach((src,i)=>{ const d=document.createElement('div'); d.className='slide'; const img=document.createElement('img'); img.loading='lazy'; img.alt=`${key} ${i+1}`; img.src=src; d.appendChild(img); rail.appendChild(d); });
        const prev=document.createElement('button'); prev.type='button'; prev.className='ctrl prev'; prev.textContent='â€¹';
        const next=document.createElement('button'); next.type='button'; next.className='ctrl next'; next.textContent='â€º';
        const labels={it:{prev:'Precedente',next:'Successiva'}, en:{prev:'Previous',next:'Next'}, de:{prev:'ZurÃ¼ck',next:'Weiter'}};
        const lang=(document.documentElement.lang||'it').toLowerCase(); prev.setAttribute('aria-label',(labels[lang]||labels.en).prev); next.setAttribute('aria-label',(labels[lang]||labels.en).next);
        sl.innerHTML=''; sl.appendChild(rail); sl.append(prev,next);
        const slides=Array.from(rail.children);
const nearIndex=()=>{
  const x=rail.scrollLeft;
  let idx=0, best=1e9;
  for(let i=0;i<slides.length;i++){ const d=Math.abs(slides[i].offsetLeft - x); if(d<best){best=d; idx=i;} }
  return idx;
};
const go=dir=>{
  const i=nearIndex()+dir;
  const clamped=Math.max(0, Math.min(slides.length-1, i));
  rail.scrollTo({left:slides[clamped].offsetLeft, behavior:'smooth'});
};
const scrollByPage=dir=>go(dir);
        prev.addEventListener('click',()=>scrollByPage(-1)); next.addEventListener('click',()=>scrollByPage(1));
      });
    }).catch(err=>console.error('[snap-slider] init error:', err));
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();